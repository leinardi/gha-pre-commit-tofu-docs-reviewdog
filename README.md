# Run OpenTofu docs via pre-commit + reviewdog

This GitHub Action runs the `tofu_docs` hook from [`pre-commit-opentofu`](https://github.com/tofuutils/pre-commit-opentofu) on a ref range and posts
documentation update suggestions (generated by `terraform-docs`) to pull requests as a diff review
using [reviewdog](https://github.com/reviewdog/reviewdog).

It is intended to keep your OpenTofu module documentation (e.g. README tables) in sync with the module code.

## Requirements

Add the `tofu_docs` hook to your `.pre-commit-config.yaml`:

```yaml
repos:
  - repo: https://github.com/tofuutils/pre-commit-opentofu
    rev: v2.2.2
    hooks:
      - id: tofu_docs
        args:
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true
````

You also need:

* GitHub Actions enabled on the repository
* `secrets.GITHUB_TOKEN` available (default on GitHub-hosted runners)
* Network access to download the `terraform-docs` binary from GitHub releases
* `actions/checkout` fetching enough history to include both `from-ref` and `to-ref`, for example:

```yaml
- uses: actions/checkout@v4
  with:
    fetch-depth: 0
```

## Inputs

| Name                     | Required | Default   | Description                                              |
|--------------------------|----------|-----------|----------------------------------------------------------|
| `from-ref`               | ✅        | –         | Base git ref (e.g. PR base SHA)                          |
| `to-ref`                 | ✅        | –         | Head git ref (e.g. PR head SHA)                          |
| `github-token`           | ✅        | –         | GitHub token for reviewdog (`secrets.GITHUB_TOKEN`)      |
| `terraform-docs-version` | ❌        | `v0.20.0` | `terraform-docs` version tag to install (e.g. `v0.20.0`) |

## Outputs

| Name       | Description                                           |
|------------|-------------------------------------------------------|
| `exitcode` | Exit code returned by the `tofu_docs` pre-commit hook |

## Usage

Example workflow for pull requests:

```yaml
name: Update OpenTofu docs with tofu_docs

on:
  pull_request:

jobs:
  tofu-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run OpenTofu docs via pre-commit + reviewdog
        uses: leinardi/gha-pre-commit-tofu-docs-reviewdog@v1
        with:
          from-ref: ${{ github.event.pull_request.base.sha }}
          to-ref: ${{ github.event.pull_request.head.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Optional:
          # terraform-docs-version: v0.20.0
```

This will:

1. Run `tofu_docs` on OpenTofu modules changed between `from-ref` and `to-ref`.
2. Use `terraform-docs` to update or create documentation files (for example, READMEs).
3. Capture those changes as a diff.
4. Post a review with suggested documentation changes (`opentofu docs`) via reviewdog.
5. Fail the job if documentation updates are required.

## Versioning

It’s recommended to pin to the major version:

```yaml
uses: leinardi/gha-pre-commit-tofu-docs-reviewdog@v1
```

For fully reproducible behavior, pin to an exact tag:

```yaml
uses: leinardi/gha-pre-commit-tofu-docs-reviewdog@v1.0.0
```
